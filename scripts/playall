#!/bin/bash

trap exitcleanly SIGINT
function exitcleanly() {
	rm $playlist $script
	exit 0
}

rand="$RANDOM"

playlist="/run/shm/playall-playlist-$rand.m3u"
script="/run/shm/playall-script-$rand.sh"

echo "loading playlist ..."
input="$1"
if [ -z "$input" ]; then
	input="."
fi
if [ -d "$input" ]; then
	find "$input" -type f | grep -E "avi$|mp4$|mkv$" | sort > $playlist
else
	cat "$input" > $playlist
fi

echo "playlist files ..."
echo -e "#/bin/bash\n" > $script
echo -e "previous=\"\$HOME/Videos/previous.mkv\"\n" >> $script
echo -e "current=\"\$HOME/Videos/current.mkv\"\n" >> $script
cat $playlist | while read line; do
	echo -e "\nclear" >> $script
	echo -e "echo \"$line\"" >> $script
	echo -e "pv < \"$line\" > \$current &" >> $script
	echo -e "omxplayer -b -o hdmi \"\$previous\"" >> $script
	echo -e "wait" >> $script
	echo -e "rm \$previous" >> $script
	echo -e "mv \$current \$previous" >> $script
done
echo -e "rm \$previous\n" >> $script

bash $script

exitcleanly
